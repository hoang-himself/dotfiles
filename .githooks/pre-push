#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo 'Running pre-push hook.'

tmpfile=$(mktemp -t pre-push.XXXXXX 2>/dev/null || mktemp 2>/dev/null || echo "${TMPDIR:-/tmp}/pre-push.$$.refs")
trap 'rm -f "$tmpfile"' EXIT

cat > "$tmpfile"

while IFS=' ' read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$local_sha" =~ ^0+$ ]]; then
    echo "Skipping validation for branch deletion: ${remote_ref#refs/heads/}"
    continue
  fi

  branch_name="${local_ref#refs/heads/}"

  if [[ "$remote_sha" =~ ^0+$ ]]; then
    commit_range="$local_sha"
  else
    commit_range="$remote_sha..$local_sha"
  fi

  for script in "$SCRIPT_DIR/pre-push.d"/*.sh; do
    if [ -f "$script" ] && [ -x "$script" ]; then
      case "$(basename "$script")" in
        assert-commit-is-local.sh)
          "$script" "$commit_range"
          ;;
        *)
          "$script" "$branch_name"
          ;;
      esac
    fi
  done
done < "$tmpfile"

echo 'Pre-push checks passed.'
exit 0
